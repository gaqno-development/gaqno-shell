# PR-Agent: AI-powered code review
# https://github.com/qodo-ai/pr-agent
# Auto describe/review/improve on opened, reopened, ready_for_review, synchronize (pr_actions includes synchronize).
name: PR Agent

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
jobs:
  pr_agent_job:
    if: >-
      ${{
        github.event.sender.type != 'Bot' &&
        (
          (github.event_name == 'pull_request' &&
           contains(fromJson('["OWNER","MEMBER","COLLABORATOR"]'), github.event.pull_request.author_association)) ||
          (github.event_name == 'issue_comment' &&
           github.event.issue.pull_request != null &&
           contains(fromJson('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association))
        )
      }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write
    name: Run pr agent on every pull request, respond to user comments
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: PR Agent action step
        id: pragent
        uses: qodo-ai/pr-agent@main
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"
          github_action_config.pr_actions: '["opened","reopened","ready_for_review","synchronize"]'
      - name: Notify on PR Agent failure
        if: failure() && (github.event.pull_request != null || github.event.issue != null)
        run: |
          PR_NUM="${{ github.event.pull_request.number || github.event.issue.number }}"
          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "⚠️ **PR Agent** falhou. Confira o [log do workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}). Causa comum: **cota OpenAI esgotada** — verifique plano e billing: https://platform.openai.com/account/billing"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
